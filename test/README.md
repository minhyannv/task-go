# TaskGo 测试套件

🧪 这是 TaskGo 的统一测试套件，包含完整的生产者-消费者测试场景。

## 🚀 快速运行

确保 Redis 服务正在运行：

```bash
# 启动 Redis (Docker 方式)
docker run -d --name redis -p 6379:6379 redis redis-server --requirepass 123456

# 运行统一测试套件
cd test
go run main.go
```

## 📋 测试场景

### 1️⃣ 基础生产者-消费者测试

**测试内容**：
- ✅ 单个生产者生产 20 个任务
- ✅ 消费者同时消费任务
- ✅ 实时监控队列状态
- ✅ 统计成功率和吞吐量

**预期结果**：
- 所有任务成功生产和消费
- 成功率接近 100%
- 生产和消费速率基本匹配

### 2️⃣ 高并发测试

**测试内容**：
- ✅ 3 个并发生产者，每个生产 15 个任务
- ✅ 总共 45 个任务的高并发场景
- ✅ 测试队列在高负载下的表现
- ✅ 监控峰值队列长度

**预期结果**：
- 高并发下系统稳定运行
- 任务无丢失，成功率高
- 队列能够有效缓冲并发请求

### 3️⃣ 错误处理测试

**测试内容**：
- ✅ 故意让任务处理失败
- ✅ 测试重试机制
- ✅ 验证错误统计准确性
- ✅ 确认系统稳定性

**预期结果**：
- 错误任务被正确识别
- 系统不会因为个别任务失败而崩溃
- 错误统计准确

## 📊 测试输出

测试过程中会显示：

### 实时监控信息
```
📊 [监控器] 实时状态:
   运行时间: 15.2s
   已生产: 12 个
   已消费: 10 个
   积压任务: 2 个
   错误数量: 0 个
   队列长度: 2 个
   峰值队列: 3 个
   成功率: 83.3%
   生产速率: 0.79 tasks/sec
   消费速率: 0.66 tasks/sec
================================
```

### 任务处理日志
```
✅ [生产者] [order] 任务 1 已提交: a1b2c3d4...
📦 [消费者] 处理订单: {"order_id":"ORD000001",...}
📧 [消费者] 发送邮件: {"to":"user@test.com",...}
📱 [消费者] 发送短信: {"phone":"138****8000",...}
```

### 最终测试报告
```
🎯 基础测试最终报告:
=================================
运行时间: 45.3s
生产任务: 20 个
消费任务: 20 个
积压任务: 0 个
错误数量: 0 个
峰值队列: 3 个
成功率: 100.0%
生产速率: 0.44 tasks/sec
消费速率: 0.44 tasks/sec
=================================
```

## 🎯 测试任务类型

测试使用三种模拟任务：

### 📦 订单处理任务 (order)
```json
{
  "order_id": "ORD000001",
  "customer_id": 12345,
  "amount": 199.99,
  "items": ["商品-42"],
  "timestamp": "14:30:25"
}
```

### 📧 邮件发送任务 (email)
```json
{
  "to": "user@test.com",
  "subject": "订单确认",
  "body": "邮件内容 1",
  "timestamp": "14:30:25"
}
```

### 📱 短信发送任务 (sms)
```json
{
  "phone": "138****8000",
  "message": "验证码：123456",
  "timestamp": "14:30:25"
}
```

## ⚙️ 配置说明

### Redis 配置
```go
var (
    redisAddr = "localhost:6379"
    redisPass = "123456"
    redisDB   = 0
)
```

### 测试参数
- **基础测试**：20 个任务，单生产者
- **高并发测试**：45 个任务，3 个生产者
- **错误测试**：5 个故意失败的任务

## 🔍 性能指标

测试关注的关键指标：

| 指标 | 说明 | 预期值 |
|------|------|--------|
| **成功率** | 成功消费 / 总生产 | > 95% |
| **生产速率** | 任务/秒 | 0.5-2.0 |
| **消费速率** | 任务/秒 | 0.5-2.0 |
| **峰值队列** | 最大积压任务数 | < 10 |
| **错误率** | 失败任务比例 | < 5% |

## 🛠️ 故障排除

### Redis 连接失败
```bash
# 检查 Redis 是否运行
redis-cli ping

# 检查密码是否正确
redis-cli -a 123456 ping
```

### 任务处理慢
- 检查 Redis 内存使用
- 调整任务处理时间
- 增加工作器数量

### 测试超时
- 增加等待时间
- 减少测试任务数量
- 检查系统资源使用

## 📈 扩展测试

可以根据需要修改测试参数：

```go
// 增加任务数量
go producer(ctx, queue, 100, &wg) // 100个任务

// 增加生产者数量
producerCount := 5 // 5个生产者

// 调整监控频率
ticker := time.NewTicker(3 * time.Second) // 3秒监控一次
```

---

🎉 **统一测试套件让 TaskGo 的测试更加简洁和高效！** 🚀 